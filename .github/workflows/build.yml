name: Build QuickJS for Android (static)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a]

    steps:
      - uses: actions/checkout@v4

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          add-to-path: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential make wget

      - name: Setup environment for ${{ matrix.abi }}
        run: |
          export API=21
          case "${{ matrix.abi }}" in
            arm64-v8a)
              HOST_TRIPLE="aarch64-linux-android"
              TLS_ALIGN=64
              ;;
            armeabi-v7a)
              HOST_TRIPLE="armv7a-linux-androideabi"
              TLS_ALIGN=32
              ;;
          esac
          TOOLCHAIN="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin"
          BUILD_ROOT="$GITHUB_WORKSPACE/build/${{ matrix.abi }}"
          mkdir -p "$BUILD_ROOT"
          echo "API=$API" >> $GITHUB_ENV
          echo "HOST_TRIPLE=$HOST_TRIPLE" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          echo "BUILD_ROOT=$BUILD_ROOT" >> $GITHUB_ENV
          echo "TLS_ALIGN=$TLS_ALIGN" >> $GITHUB_ENV
          echo "CC=$TOOLCHAIN/${HOST_TRIPLE}${API}-clang" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN/llvm-strip" >> $GITHUB_ENV

      - name: Download QuickJS source
        run: wget https://bellard.org/quickjs/quickjs-2025-09-13-2.tar.xz

      - name: Extract source
        run: |
          mkdir quickjs-src
          tar -xf quickjs-2025-09-13-2.tar.xz -C quickjs-src --strip-components=1

      - name: Build native (to generate required source files)
        working-directory: quickjs-src
        run: make -j$(nproc)

      - name: Prepare cross build directory
        run: |
          cp -r quickjs-src quickjs-cross
          cp quickjs-src/repl.c quickjs-cross/ 2>/dev/null || true
          cp quickjs-src/hello.c quickjs-cross/ 2>/dev/null || true
          cp quickjs-src/test_fib.c quickjs-cross/ 2>/dev/null || true

      - name: Create TLS alignment assembly
        working-directory: quickjs-cross
        run: |
          cat > tls_force_align.S <<EOF
          .section .tdata,"awT",%progbits
          .p2align $(echo "l(${TLS_ALIGN})/l(2)" | bc -l | cut -d. -f1)
          .globl quickjs_tls_force_align
          .type quickjs_tls_force_align, %object
          .size quickjs_tls_force_align, ${TLS_ALIGN}
          quickjs_tls_force_align:
          .zero ${TLS_ALIGN}
          EOF

      - name: Build qjs for Android ${{ matrix.abi }}
        working-directory: quickjs-cross
        env:
          PATH: ${{ env.TOOLCHAIN }}:/usr/bin:/bin
        run: |
          export CC="$CC"
          export AR="$AR"
          export RANLIB="$RANLIB"
          export CFLAGS="-fPIC -O2 -ftls-model=initial-exec -pthread"
          export LDFLAGS="-static -pthread -Wl,-z,max-page-size=16384 -Wl,-z,common-page-size=16384 -Wl,--section-start=.tdata=0x1000000"
          # Compile the TLS alignment object
          $CC -c tls_force_align.S -o tls_force_align.o
          # Build qjs, using the native qjsc and adding our TLS object
          make qjs \
            CC="$CC" \
            AR="$AR" \
            QJSC="../quickjs-src/qjsc" \
            EXTRA_OBJS="tls_force_align.o" \
            LDFLAGS="$LDFLAGS" \
            -j$(nproc)

      - name: Strip binary
        run: |
          cp quickjs-cross/qjs qjs-${{ matrix.abi }}
          $STRIP qjs-${{ matrix.abi }}

      - name: Verify binary (optional)
        run: |
          echo "=== Binary Info ==="
          file qjs-${{ matrix.abi }}
          echo "=== TLS Section Info ==="
          readelf -S qjs-${{ matrix.abi }} | grep -E '(\.tdata|\.tbss)' || true

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: qjs-${{ matrix.abi }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
