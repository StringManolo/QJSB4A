name: Build QuickJS for ARM and upload to release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: armv7
            triplet: arm-linux-gnueabihf
            output: qjs-armv7
          - arch: aarch64
            triplet: aarch64-linux-gnu
            output: qjs-aarch64

    steps:
      - name: Install cross-compilation tools
        run: |
          sudo apt update
          sudo apt install -y make gcc-${triplet} binutils-${triplet}
        env:
          triplet: ${{ matrix.triplet }}

      - name: Download QuickJS source
        run: wget https://bellard.org/quickjs/quickjs-2025-09-13-2.tar.xz

      - name: Extract source to known directory
        run: |
          mkdir quickjs-src
          tar -xf quickjs-2025-09-13-2.tar.xz -C quickjs-src --strip-components=1

      - name: Prepare native build directory
        run: cp -r quickjs-src quickjs-native

      - name: Build native (to generate required source files)
        working-directory: quickjs-native
        run: make -j$(nproc)

      - name: Prepare cross build directory
        run: |
          cp -r quickjs-src quickjs-cross
          # Copy generated source files from native build to cross build
          cp quickjs-native/repl.c quickjs-cross/ 2>/dev/null || true
          cp quickjs-native/hello.c quickjs-cross/ 2>/dev/null || true
          cp quickjs-native/test_fib.c quickjs-cross/ 2>/dev/null || true

      - name: Build qjs for ${{ matrix.arch }}
        working-directory: quickjs-cross
        run: |
          make qjs \
            CC=${{ matrix.triplet }}-gcc \
            AR=${{ matrix.triplet }}-ar \
            QJSC=../quickjs-native/qjsc \
            -j$(nproc)

      - name: Copy and strip binary
        run: |
          cp quickjs-cross/qjs ${{ matrix.output }}
          ${{ matrix.triplet }}-strip ${{ matrix.output }}

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.output }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
